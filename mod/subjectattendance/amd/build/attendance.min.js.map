{"version":3,"file":"attendance.min.js","sources":["../src/attendance.js"],"sourcesContent":["define(['jquery'], function($) {\n\n    /**\n     * Updates the CSS classes of a select element depending on its value.\n     * @param {HTMLElement} select - the select element.\n     */\n    function updateClass(select) {\n        let val = $(select).val();\n        $(select).removeClass(\"present partial absent none\");\n        if (val === \"2\") {\n            $(select).addClass(\"present\");\n        } else if (val === \"1\") {\n            $(select).addClass(\"partial\");\n        } else if (val === \"0\") {\n            $(select).addClass(\"absent\");\n        } else {\n            $(select).addClass(\"none\");\n        }\n    }\n\n    /**\n     * Recalculates and updates the summary for a table row.\n     * @param {HTMLElement} row - the table row (tr).\n     */\n    function updateRowSummary(row) {\n        let present = 0;\n        let partial = 0;\n        let absent = 0;\n\n        $(row).find(\".attendance-select\").each(function() {\n            if ($(this).val() === \"2\") {\n                present++;\n            } else if ($(this).val() === \"1\") {\n                partial++;\n            } else if ($(this).val() === \"0\") {\n                absent++;\n            }\n        });\n\n        let $summary = $(row).find(\".attendance-summary\");\n        if (!$summary.length) {\n            return;\n        }\n\n        $summary.html(\n            (present ? \"<div style='flex: 1; background: #c8e6c9;'>\" + present + \"</div>\" : \"\") +\n            (partial ? \"<div style='flex: 1; background: #fff9c4;'>\" + partial + \"</div>\" : \"\") +\n            (absent ? \"<div style='flex: 1; background: #ffcdd2;'>\" + absent + \"</div>\" : \"\")\n        );\n    }\n\n    /**\n     * Initializes event handlers.\n     */\n    function init() {\n        $(\".attendance-select\").each(function() {\n            updateClass(this);\n\n            $(this).on(\"change\", function() {\n                updateClass(this);\n\n                let studentid = $(this).data(\"studentid\");\n                let subjectid = $(this).data(\"subjectid\");\n                let cmid = $(this).data(\"cmid\");\n                let attendanceid = $(this).data(\"attendanceid\");\n                let status = $(this).val();\n\n                fetch(M.cfg.wwwroot + \"/mod/subjectattendance/ajax_save.php\", {\n                    method: \"POST\",\n                    headers: {\n                        \"Content-Type\": \"application/json\",\n                        \"Accept\": \"application/json\"\n                    },\n                    body: JSON.stringify({\n                        sesskey: M.cfg.sesskey,\n                        studentid,\n                        subjectid,\n                        cmid,\n                        attendanceid,\n                        status\n                    })\n                })\n                .then(r => r.json())\n                .then(data => {\n                    if (!data.success) {\n                        // eslint-disable-next-line no-alert\n                        alert(data.error);\n                        return null;\n                    } else {\n                        updateRowSummary($(this).closest(\"tr\"));\n                        return data;\n                    }\n                })\n                .catch(error => {\n                    // eslint-disable-next-line no-alert\n                    alert(error);\n                });\n            });\n        });\n\n        $(document).on(\"change\", \".attendance-col-select\", function() {\n            let subjectid = $(this).data(\"subjectid\");\n            let value = $(this).val();\n            let $self = $(this);\n\n            if (!$self.next(\".mass-apply-confirm\").length) {\n                let $panel = $(`\n                    <span class=\"mass-apply-confirm\" style=\"margin-left:8px;\">\n                        <button type=\"button\" class=\"btn btn-warning btn-sm mt-2 apply\">\n                        ${M.util.get_string('apply', 'core')}</button>\n                        <button type=\"button\" class=\"btn btn-secondary btn-sm mt-2 cancel\">\n                        ${M.util.get_string('cancel', 'core')}</button>\n                    </span>\n                `);\n                $self.after($panel);\n\n                $panel.find(\".apply\").on(\"click\", function() {\n                    $(\".attendance-select[data-subjectid='\" + subjectid + \"']\").each(function() {\n                        $(this).val(value).trigger(\"change\");\n                    });\n                    $panel.remove();\n                });\n\n                $panel.find(\".cancel\").on(\"click\", function() {\n                    $self.val(\"\");\n                    $panel.remove();\n                });\n            }\n        });\n    }\n\n    return {init: init};\n});\n"],"names":["define","$","updateClass","select","val","removeClass","addClass","init","each","this","on","studentid","data","subjectid","cmid","attendanceid","status","fetch","M","cfg","wwwroot","method","headers","body","JSON","stringify","sesskey","then","r","json","success","row","present","partial","absent","find","$summary","length","html","updateRowSummary","closest","alert","error","catch","document","value","$self","next","$panel","util","get_string","after","trigger","remove"],"mappings":"AAAAA,0CAAO,CAAC,WAAW,SAASC,YAMfC,YAAYC,YACbC,IAAMH,EAAEE,QAAQC,MACpBH,EAAEE,QAAQE,YAAY,+BACV,MAARD,IACAH,EAAEE,QAAQG,SAAS,WACJ,MAARF,IACPH,EAAEE,QAAQG,SAAS,WACJ,MAARF,IACPH,EAAEE,QAAQG,SAAS,UAEnBL,EAAEE,QAAQG,SAAS,cAmHpB,CAACC,gBA5EJN,EAAE,sBAAsBO,MAAK,WACzBN,YAAYO,MAEZR,EAAEQ,MAAMC,GAAG,UAAU,WACjBR,YAAYO,UAERE,UAAYV,EAAEQ,MAAMG,KAAK,aACzBC,UAAYZ,EAAEQ,MAAMG,KAAK,aACzBE,KAAOb,EAAEQ,MAAMG,KAAK,QACpBG,aAAed,EAAEQ,MAAMG,KAAK,gBAC5BI,OAASf,EAAEQ,MAAML,MAErBa,MAAMC,EAAEC,IAAIC,QAAU,uCAAwC,CAC1DC,OAAQ,OACRC,QAAS,gBACW,0BACN,oBAEdC,KAAMC,KAAKC,UAAU,CACjBC,QAASR,EAAEC,IAAIO,QACff,UAAAA,UACAE,UAAAA,UACAC,KAAAA,KACAC,aAAAA,aACAC,OAAAA,WAGPW,MAAKC,GAAKA,EAAEC,SACZF,MAAKf,MACGA,KAAKkB,kBA5DAC,SAClBC,QAAU,EACVC,QAAU,EACVC,OAAS,EAEbjC,EAAE8B,KAAKI,KAAK,sBAAsB3B,MAAK,WACb,MAAlBP,EAAEQ,MAAML,MACR4B,UACyB,MAAlB/B,EAAEQ,MAAML,MACf6B,UACyB,MAAlBhC,EAAEQ,MAAML,OACf8B,gBAIJE,SAAWnC,EAAE8B,KAAKI,KAAK,uBACtBC,SAASC,QAIdD,SAASE,MACJN,QAAU,8CAAgDA,QAAU,SAAW,KAC/EC,QAAU,8CAAgDA,QAAU,SAAW,KAC/EC,OAAS,8CAAgDA,OAAS,SAAW,KA0ClEK,CAAiBtC,EAAEQ,MAAM+B,QAAQ,OAC1B5B,OAJP6B,MAAM7B,KAAK8B,OACJ,QAMdC,OAAMD,QAEHD,MAAMC,gBAKlBzC,EAAE2C,UAAUlC,GAAG,SAAU,0BAA0B,eAC3CG,UAAYZ,EAAEQ,MAAMG,KAAK,aACzBiC,MAAQ5C,EAAEQ,MAAML,MAChB0C,MAAQ7C,EAAEQ,UAETqC,MAAMC,KAAK,uBAAuBV,OAAQ,KACvCW,OAAS/C,gNAGHiB,EAAE+B,KAAKC,WAAW,QAAS,mJAE3BhC,EAAE+B,KAAKC,WAAW,SAAU,qEAGtCJ,MAAMK,MAAMH,QAEZA,OAAOb,KAAK,UAAUzB,GAAG,SAAS,WAC9BT,EAAE,sCAAwCY,UAAY,MAAML,MAAK,WAC7DP,EAAEQ,MAAML,IAAIyC,OAAOO,QAAQ,aAE/BJ,OAAOK,YAGXL,OAAOb,KAAK,WAAWzB,GAAG,SAAS,WAC/BoC,MAAM1C,IAAI,IACV4C,OAAOK"}